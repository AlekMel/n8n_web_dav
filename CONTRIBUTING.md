# Руководство для разработчиков

## Структура проекта

```
web_dav/
├── src/                          # Исходный код TypeScript
│   ├── credentials/              # Определения учетных данных для n8n
│   │   └── WebDavApi.credentials.ts
│   ├── nodes/                    # Определения нод для n8n
│   │   └── WebDav/
│   │       ├── WebDav.node.ts    # Основная логика ноды
│   │       └── webdav.svg        # Иконка ноды
│   ├── webdav-client.ts          # Собственная реализация WebDAV клиента
│   ├── n8n-types.d.ts            # TypeScript определения типов
│   └── index.ts                  # Точка входа для экспорта
├── dist/                         # Скомпилированные файлы (генерируется)
├── build.js                      # Скрипт сборки
├── tsconfig.json                 # Конфигурация TypeScript
├── package.json                  # Зависимости и метаданные
├── test-manual.js                # Ручной тестовый скрипт
├── CHANGELOG.md                  # История изменений
└── README.md                     # Основная документация
```

## Установка для разработки

```bash
# Клонировать репозиторий
git clone https://github.com/AlekMel/n8n-nodes-webdav.git
cd n8n-nodes-webdav

# Установить зависимости
npm install

# Запустить режим разработки (автоматическая перекомпиляция)
npm run dev
```

## Разработка

### Сборка проекта

```bash
npm run build
```

### Режим разработки

```bash
npm run dev
```

Этот режим будет автоматически перекомпилировать TypeScript файлы при их изменении.

### Линтинг

```bash
npm run lint
```

### Тестирование

Для ручного тестирования:

1. Настройте учетные данные в `test-manual.js`
2. Запустите тесты:

```bash
npm run test:manual
```

**ВАЖНО**: Не коммитьте `test-manual.js` с реальными учетными данными!

## Архитектура WebDAV клиента

### Основные компоненты

#### WebDAVClient

Основной класс для работы с WebDAV протоколом. Использует Axios для HTTP запросов и fast-xml-parser для обработки XML ответов.

**Ключевые методы:**

- `exists(filePath)` - проверка существования ресурса
- `getFileContents(filePath, options)` - получение содержимого файла
- `getFileStream(filePath)` - получение файла как поток (для больших файлов)
- `putFileContents(filePath, data, options)` - загрузка файла
- `putFileStream(filePath, stream, options)` - загрузка файла из потока
- `createDirectory(dirPath)` - создание директории
- `deleteFile(filePath)` - удаление файла/директории
- `moveFile(source, destination, options)` - перемещение/переименование
- `copyFile(source, destination, options)` - копирование
- `stat(filePath)` - получение метаданных ресурса
- `getDirectoryContents(dirPath, options)` - получение списка файлов

#### WebDAVError

Специализированный класс ошибок для WebDAV операций с дополнительными полями:

- `statusCode` - HTTP статус код
- `statusText` - текстовое описание статуса
- `response` - исходный ответ сервера

### Обработка XML

Проект использует `fast-xml-parser` для корректной обработки WebDAV PROPFIND ответов.

**Ключевые функции:**

- `parseWebDAVResponse(xmlData)` - парсинг XML в структурированный формат
- `normalizeWebDAVResponse(response)` - нормализация с учетом различных namespace префиксов (d:, D:, без префикса)
- `webdavResponseToFileInfo(response)` - преобразование в `FileInfo` объект

### Обработка ошибок

Все методы используют централизованную обработку ошибок через `handleError()`, которая:

1. Определяет тип ошибки (Axios/WebDAV)
2. Извлекает HTTP статус код
3. Формирует понятное сообщение на основе статус кода
4. Выбрасывает `WebDAVError` с детальной информацией

**Поддерживаемые HTTP коды:**

- 401 - Ошибка аутентификации
- 403 - Доступ запрещен
- 404 - Ресурс не найден
- 405 - Метод не поддерживается
- 409 - Конфликт (файл уже существует)
- 412 - Предусловие не выполнено
- 423 - Ресурс заблокирован
- 507 - Недостаточно места на сервере

## Интеграция с n8n

### Структура ноды

Нода реализует интерфейс `INodeType` из `n8n-workflow` и включает:

1. **Description** - метаданные ноды (имя, иконка, версия)
2. **Properties** - определение параметров ноды
3. **Execute** - основная логика выполнения

### Добавление новых операций

Для добавления новой операции:

1. Добавьте enum в `FileOperation` или `FolderOperation`
2. Добавьте опцию в соответствующее меню операций
3. Добавьте параметры для новой операции (если нужно)
4. Реализуйте логику в методе `execute()`

### Тестирование в n8n

```bash
# Линковка пакета для локальной разработки
npm link

# В директории n8n
npm link n8n-nodes-webdav-yandex

# Перезапуск n8n
n8n start
```

## Лучшие практики

1. **TypeScript типы** - всегда используйте строгую типизацию
2. **Обработка ошибок** - используйте WebDAVError для WebDAV специфичных ошибок
3. **Тестирование** - тестируйте с разными WebDAV серверами
4. **Документация** - документируйте новые методы с JSDoc
5. **Версионирование** - следуйте Semantic Versioning
6. **CHANGELOG** - обновляйте CHANGELOG.md при изменениях

## Публикация новой версии

1. Обновите версию в `package.json`
2. Обновите `CHANGELOG.md`
3. Соберите проект: `npm run build`
4. Протестируйте: `npm run test:manual`
5. Закоммитьте изменения
6. Создайте git tag: `git tag v0.1.X`
7. Опубликуйте: `npm publish`

## Поддержка

При возникновении проблем:

1. Проверьте CHANGELOG.md для известных проблем
2. Откройте Issue на GitHub
3. Предоставьте подробное описание проблемы и логи

## Лицензия

MIT - см. LICENSE файл для деталей

